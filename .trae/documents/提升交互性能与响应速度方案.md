# 关键改进点
- 初始化一次：集合与嵌入模型、HTTP 会话在启动时初始化并复用，避免每次 `query_rag` 重建。
- 轻量初检：批量嵌入查询文本，Chroma 返回 `documents/metadatas/distances`，不返回大体积 `embeddings`。
- 候选控制：多查询并集后按距离预排序，仅保留前 `pool_k` 再走重排序，减少 reranker 负载。
- 连接复用：`requests.Session` + 超时/重试，降低握手与失败成本。
- 可切换快速模式：交互默认减少查询扩展次数，必要时再开。

# 按需图片处理（针对你提议）
- 明确“仅当用户提交图片且未命中缓存时”才进行图片摘要：
  - 无图片：完全跳过图片逻辑（不调用视觉模型、不生成图片要点）。
  - 有图片：首次设置后在首次问答时生成摘要并缓存；之后复用缓存，不重复调用。
  - 交互命令：`:images`/`:add_images` 设置或追加；`:clear_images` 清空（缓存失效）；`:list_images` 查看。
  - 可选开关：`:fast_on` 时默认不做图片摘要，除非显式 `:describe` 触发；`:fast_off` 自动在首次问题时生成摘要。

# 实施清单（改动点）
1. 模块级单例：`COLLECTION/EMBEDDER/CHAT_SESSION/RERANK_SESSION` 在启动时初始化并复用。
2. 图片摘要缓存：`image_summary_cache[(tuple(paths))] -> str`；无图片时直接跳过图片分支。
3. 查询扩展缓存：`query_expand_cache[key]`；快速模式下仅保留“原句+压缩句”。
4. 批量嵌入与轻量返回：`embed_documents(query_texts)`；Chroma `include=['documents','metadatas','distances']`，相似度由 `1 - distance`（余弦度量）得到。
5. 候选池阈值：并集去重后按距离取前 `pool_k`（如 80），再调用 reranker。
6. 会话与重试：`requests.Session()` + `Retry(total=3, backoff_factor=0.3)`；所有请求设置合理 `timeout`。
7. 交互命令与耗时日志：`fast_on/off`、`:set top_k/rerank_k/alpha`；打印各阶段耗时统计。

# 验收标准
- 连续交互平均耗时下降 ≥30%；无图片场景下明显加速（跳过图片摘要）。
- 命中质量与当前持平或优化；快速模式下可在需要时开查询扩展或图片摘要。
- 启动仅初始化一次；日志可见各阶段耗时与重试情况。

# 风险控制
- 若 Chroma 距离度量非余弦，则改为请求 `embeddings` 备选路径；选择最轻量的稳定方案。
- 批量嵌入受限流时分批请求；图片摘要缓存避免重复费用与延迟。