## 问题诊断
- 现象：知识库中存在相关 QA，但最终回答出现“很抱歉，我的知识库中没有找到…”。
- 根因可能：
  - 召回未命中或命中排在 Top-3 之外（`_build_answer` 仅取前 3 条）。
  - 快速模式下查询扩展不足，语义偏差导致相关片段未进入候选。
  - 重排序对边缘相关的片段给出更高分，压过真正答案。
  - 提示策略过严，模型在“有近似但不完全匹配”时倾向于拒答。
  - 相似度使用与向量度量不一致，导致排序失真。

## 解决方案概览
- 多层保障“有命中就不拒答”，优化召回→排序→上下文选择→提示策略。

## 具体改动
### 1. 输出层保护（必做，立竿见影）
- 规则：当 `contexts` 非空时，禁止输出“未找到”；仅在 `contexts` 为空时才触发该提示。
- 实现：
  - 在 `_build_answer` 前做判断：若 `reranked` 为空，直接返回固定的“未找到”模板；否则必须基于上下文作答。
  - 提示文案中去掉“信息不足的拒答”路径，改为“尽可能以片段信息作答；若上下文确实没有关键信息则指出缺少具体字段，但仍给出现有依据”。

### 2. 上下文选择扩大与精化
- 将可供生成的上下文从 Top-3 扩大到 Top-5，并采用“精挑”策略：
  - 除按融合分排名外，优先保留包含关键词（例如“问：”“答：”以及用户问题关键词）的片段。
  - 避免因为排序细微偏差导致真正答案被排除在生成上下文之外。

### 3. 关键词强制召回（兜底）
- 当初检 + 重排后的候选未包含高相似度片段时：
  - 在 `data/chunks.json` 做一次本地关键词匹配（不走向量），将包含用户核心短语的片段加入候选池；再参与重排。
- 优点：处理语义检索失误的场景，以词面匹配兜底。

### 4. 检索与排序稳健性
- 调整参数与策略：
  - 提升 `top_k` 默认到 50（交互可动态降到 30–40），`pool_k` 维持 60–80。
  - 快速模式下保留“原句+压缩句”，遇到未命中时自动退回完整查询扩展（动态开关）。
- 相似度一致性：继续使用 `1 - distance`（余弦度量）作为相似度；若检测到度量非余弦，则回退到请求 `embeddings` 计算余弦。

### 5. 提示策略微调
- 系统提示改为：
  - “仅基于传入片段作答；若缺少关键字段，请明确指出缺少项，但不得整体拒答”。
  - 保留“来源页码/文件名”与“粗体关键信息”输出规则。
- 用户消息中追加指令：
  - 明确要求从传入片段中提炼结论，不得以“非完全匹配”为由拒答。

### 6. 诊断与测试
- 增加调试日志（可通过 `--debug` 开启）：打印查询 variants、各阶段候选数量、Top-N 分数、是否触发关键词兜底。
- 添加两个回归用例：
  - “考试缺考影响下一次报考吗？”应返回明确“不影响”的结论并给出依据页码。
  - 你提供的“明确有问答却被判未找到”的具体问题，验证不再出现拒答。

## 验收标准
- 当知识库存在相关片段时，不再出现“未找到”拒答；答案来源清晰并含依据。
- Top-1/Top-3 命中率不下降，关键词兜底触发时能显著提升召回稳定性。
- 交互耗时控制在当前优化水平（快速模式下首答 ≤3–5s，视网络与模型时延）。

## 后续可选优化
- 引入稀疏检索（BM25 或 BGE-M3 的 sparse 向量）与密集检索融合，进一步提升召回稳健性。
- 针对问答体裁（“问：”“答：”）做结构化解析与标签，召回时优先“type=qa_pair”。