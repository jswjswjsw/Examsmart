## 目标
- 将当前“按字符切割”的粒度升级为“按主题聚合”的语义粒度，避免过度原子化导致检索不准。
- 针对问答资料（问/答）创建“主题段落（章节/小节）+问答对”的双粒度索引，提升粗检与精检的命中率与上下文完整性。

## 总体思路
- 保留已有的问答对识别（qa_pair），新增“主题聚合文档（section_chunk）”。
- 先按文档中的章节/小节标题识别主题，再将后续问答对按主题聚合为若干 chunk（控制大小与边界）。
- 检索管线采用“双通道”策略：先用主题聚合 chunk 粗检定位范围，再用问答对精检抽取具体答案。

## 主题识别规则
- 标题模式（正则）：
  - `^[一二三四五六七八九十百]+、.+$`（如“二、春考”）
  - `^[（\(][一二三四五六七八九十]+[）\)].+$`（如“（一）报名篇”）
- 关键词指示：如“报名篇/录取篇/志愿篇/材料/档案/补贴/春考/秋考/艺考”等，作为辅助主题提示。
- 结构绑定：遇到标题则更新当前主题上下文，后续问答归入该主题，直到出现下一个标题。

## 聚合与切块策略
- 聚合单位：一个主题下的若干问答对，形成 `section_chunk`。
- 大小控制：
  - 目标长度 1200–1800 字符，重叠 200 字符；边界严格对齐问答对，不在问答中间切断。
  - 超长主题：按问答组批次拆分，如每 5–8 个问答为一组，或按长度阈值。
- 原子保留：保留单条 `qa_pair` 文档，用于精检与答案抽取。

## 输出结构
- `data/chunks.json` 中混合两类文档：
  - `type='section_chunk'`：包含 `section_path`（如 `["春考","报名篇"]`）、`qa_ids`、`page_range`、`source`。
  - `type='qa_pair'`：问答对文本与其 `qa_id`、所属 `section_path`。
- 可选：`data/sections_index.json`（轻量主题索引，主题到 chunk 的映射）。

## 代码改动点
- 在 `src/1_dataTreating.py`：
  - 保留已实现的 `extract_content_items` 与 `segment_qa_pairs`。
  - 新增 `detect_sections(items)`：识别并维护当前主题 `section_path`（大/小节），为每个 QA 注入主题元数据。
  - 新增 `aggregate_by_section(qa_docs)`：按主题将问答对聚为 `section_chunk`，实现长度/边界控制。
  - 调整 `chunk_documents(...)`：对 `general_text` 仍用递归切分；对 `qa_pair` 保留；新增 `section_chunk` 生成逻辑。
  - 输出时写入混合文档，并在 metadata 中明确 `type`、`section_path`、`qa_ids`。

## 检索管线改造（`src/3_query.py`）
- 双通道检索：
  - `section_retriever`：仅检索 `type='section_chunk'`，`k1` 较小（如 3–5），用于定位主题范围。
  - `qa_retriever`：检索 `type='qa_pair'`，`k2` 较大（如 8–12），在主题范围（若可过滤）内精检答案。
- 合并与重排：
  - 对 `section_chunk` 命中的主题，优先在同主题的 `qa_pair` 中二次检索（metadata 过滤 `section_path`）。
  - 组合结果：优先返回精检问答，辅以主题 chunk 作为上下文。
- 回退策略：若未命中主题，直接使用 `qa_pair` 单通道检索，保证鲁棒性。

## 验收标准
- 针对用户示例（录取/档案/补贴/报名篇等）查询：
  - 返回的首条或前几条结果来自对应主题（如“录取篇/报名篇”）。
  - 问答文本完整不被切断；包含问题与答案；上下文不偏题。
  - 长问答仍能被适度拆分但不破坏语义边界。

## 质量与约束
- 依赖：不新增重型依赖，沿用现有 `langchain_text_splitters` 与 `langchain_core`。
- 安全：不引入敏感配置；不写入密钥。
- 文档：在 metadata 内完整标注主题与追溯信息，便于后续统计与过滤。

## 后续可选优化
- 主题关键词自动扩展：通过词频或轻量嵌入计算丰富主题词表。
- 分层主题：大节-小节两级分组，与 UI/检索过滤器联动。
- Rerank：引入轻量语义重排（如 BM25+Embedding 混合）。

请确认是否按该方案实施：我将基于现有脚本新增主题检测与聚合，更新 `chunks.json` 的结构，并改造查询管线实现双通道检索与主题过滤。